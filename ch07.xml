<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE chapter PUBLIC "-//OASIS//DTD DocBook XML V4.5//EN" "http://www.oasis-open.org/docbook/xml/4.5/docbookx.dtd">
<chapter id="ch07_xml_inj">
  <title>XML Injection</title>
  <para><indexterm><primary>XML Injection</primary></indexterm>XML Injection is the scourge of XML programming. The vulnerability is a server-side injection attack and occurs when the attacker inserts malicious code into XML document. This chapter of the book will show you how to use OWASP and ESAPI controls to protect against XML vulnerabilities.</para>
  <section id="xml_inj_documentation" xreflabel="Encoder Documentation">
    <title>Documentation</title>
    <para><indexterm><primary>XML Injection</primary><secondary>Documentation</secondary></indexterm>Documentation for ESAPI <systemitem>Encoder</systemitem> class is located at <ulink url="https://www.javadoc.io/static/org.owasp.esapi/esapi/2.5.2.0/index.html?org/owasp/esapi/Encoder.html">Interface Encoder</ulink>.</para>
    <para>Documentation for XML can be found at the W3C's <ulink url="https://www.w3.org/TR/REC-xml/"><emphasis>Extensible Markup Language (XML) 1.0 (Fifth Edition)</emphasis></ulink>.</para>
  </section>
  <section id="xml_inj_strategy">
    <title>Strategy</title>
    <para><indexterm><primary>XML Injection</primary><secondary>Strategy</secondary></indexterm>The primary defense against XML Injections in is encoding problematic characters.</para>
    <para>.</para>
    <table frame="all" id="xml_table_chars">
      <title>Encoding of XML Distinguished Name Characters</title>
      <tgroup cols="4" align="center" colsep="1" rowsep="1">
        <colspec colnum="1" colname="character" colwidth="1.2*"/>
        <colspec colnum="2" colname="encoding" colwidth="1*"/>
        <colspec colnum="3" colname="special" colwidth="1*"/>
        <colspec colnum="4" colname="comment" colwidth="3*"/>
        <thead>
          <row>
            <entry>Character</entry>
            <entry>Encoding</entry>
            <entry>Special</entry>
            <entry>Comment</entry>
          </row>
        </thead>
        <tbody>
          <row>
            <entry>NUL</entry>
            <entry>\00</entry>
            <entry>None</entry>
            <entry>Not in LUTF1, SUTF1 or TUTF1</entry>
          </row>
          <row>
            <entry>SPACE</entry>
            <entry>\20</entry>
            <entry>\SPACE</entry>
            <entry>Not in LUTF1 or TUTF1</entry>
          </row>
          <row>
            <entry>"</entry>
            <entry>\22</entry>
            <entry>\"</entry>
            <entry>Not in LUTF1, SUTF1 or TUTF1</entry>
          </row>
          <row>
            <entry>#</entry>
            <entry>\23</entry>
            <entry>\#</entry>
            <entry>Not in LUTF1</entry>
          </row>
          <row>
            <entry>+</entry>
            <entry>\2B</entry>
            <entry>\+</entry>
            <entry>Not in LUTF1, SUTF1 or TUTF1</entry>
          </row>
        </tbody>
      </tgroup>
    </table>
    <para>For search filter strings, the characters are provided in the grammar shown in <ulink url="https://tools.ietf.org/html/rfc4515#section-3">RFC 4515, Section 3</ulink>. The table below shows the characters and how to encode them for the directory. <indexterm><primary>UTF1SUBSET</primary></indexterm><indexterm><primary>XML Injection</primary><secondary>UTF1SUBSET</secondary></indexterm><systemitem>UTF1SUBSET</systemitem> is the subset of UTF-8 characters specified by RFC 4515.</para>
    <table frame="all" id="xml_table_filter_chars">
      <title>Encoding of XML Filter Characters</title>
      <tgroup cols="3" align="center" colsep="1" rowsep="1">
        <colspec colnum="1" colname="character" colwidth="1*"/>
        <colspec colnum="2" colname="encoding" colwidth="1*"/>
        <colspec colnum="3" colname="comment" colwidth="2*"/>
        <thead>
          <row>
            <entry>Character</entry>
            <entry>Encoding</entry>
            <entry>Comment</entry>
          </row>
        </thead>
        <tbody>
          <row>
            <entry>NUL</entry>
            <entry>\00</entry>
            <entry>Not in UTF1SUBSET</entry>
          </row>
          <row>
            <entry>!</entry>
            <entry>\21</entry>
            <entry>Used in Filter grammar</entry>
          </row>
          <row>
            <entry>&amp;</entry>
            <entry>\26</entry>
            <entry>Used in Filter grammar</entry>
          </row>
          <row>
            <entry>(</entry>
            <entry>\28</entry>
            <entry>Not in UTF1SUBSET</entry>
          </row>
          <row>
            <entry>)</entry>
            <entry>\29</entry>
            <entry>Not in UTF1SUBSET</entry>
          </row>
          <row>
            <entry>*</entry>
            <entry>\2A</entry>
            <entry>Not in UTF1SUBSET</entry>
          </row>
          <row>
            <entry>/</entry>
            <entry>\2F</entry>
            <entry>Required by Microsoft AD</entry>
          </row>
          <row>
            <entry>:</entry>
            <entry>\3A</entry>
            <entry>Used in Filter grammar</entry>
          </row>
          <row>
            <entry>&lt;</entry>
            <entry>\3C</entry>
            <entry>Used in Filter grammar</entry>
          </row>
          <row>
            <entry>=</entry>
            <entry>\3D</entry>
            <entry>Used in Filter grammar</entry>
          </row>
          <row>
            <entry>&gt;</entry>
            <entry>\3E</entry>
            <entry>Used in Filter grammar</entry>
          </row>
          <row>
            <entry>ESC</entry>
            <entry>\5C</entry>
            <entry>Not in UTF1SUBSET</entry>
          </row>
          <row>
            <entry>|</entry>
            <entry>\7C</entry>
            <entry>Used in Filter grammar</entry>
          </row>
          <row>
            <entry>~</entry>
            <entry>\7E</entry>
            <entry>Used in Filter grammar</entry>
          </row>
          <row>
            <entry>0x80-0xFFFF</entry>
            <entry>\hh</entry>
            <entry>Hexadecimal encoded, 2 digits<footnote><para>The character is first converted to a UTF-8 multibyte sequence, then each byte is hexadecimal encoded.</para></footnote></entry>
          </row>
        </tbody>
      </tgroup>
    </table>
  </section>
</chapter>
